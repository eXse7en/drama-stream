<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Detail Drama</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <style>
    body { background: linear-gradient(135deg, #0b1220 0%, #1e293b 100%); }
    
    #title {
      background: rgba(2,6,23,.95);
      padding: 20px;
      font-size: clamp(20px, 5vw, 28px);
      font-weight: 700;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(56,189,248,.3);
    }
    
    .stats {
      background: rgba(30,41,59,.8);
      padding: 15px 20px;
      margin: 15px 24px 0;
      border-radius: 12px;
      border: 1px solid rgba(56,189,248,.2);
      text-align: center;
      font-weight: 500;
    }
    
    .episode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: 12px;
      padding: 20px 24px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .episode-item {
      aspect-ratio: 1;
      background: rgba(30,41,59,.8);
      border: 2px solid transparent;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #fff;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .episode-item:hover {
      background: rgba(56,189,248,.2);
      border-color: #38bdf8;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(56,189,248,.3);
    }
    
    .episode-item.free { border-color: #10b981; }
    .episode-item.vip { border-color: #f59e0b; background: rgba(245,158,11,.1); }
    
    .episode-num { font-size: 14px; margin-bottom: 4px; font-weight: 700; }
    .episode-badge { font-size: 9px; padding: 2px 6px; border-radius: 6px; background: rgba(0,0,0,.7); }
    .free-badge { background: rgba(16,185,129,.9); color: #fff; }
    .vip-badge { background: rgba(245,158,11,.9); color: #fff; }
    
    .loading-more {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #94a3b8;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .episode-grid { grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 16px 16px 40px; }
    }
    @media (max-width: 480px) {
      .episode-grid { grid-template-columns: repeat(4, 1fr); }
    }
  </style>
</head>
<body>

<header id="title">Detail Drama</header>

<div class="stats" id="totalEps">Memuat...</div>

<div id="eps" class="episode-grid">
  <div style="grid-column:1/-1;text-align:center;padding:60px;color:#94a3b8;">Memuat episode...</div>
</div>

<script>
const q = new URLSearchParams(location.search);
const bookId = q.get("id");
const rawTitle = q.get("title");

let allEpisodes = [];
let loadedCount = 0;
const BATCH_SIZE = 20;

const headerEl = document.getElementById("title");
const totalEl = document.getElementById("totalEps");
const epsEl = document.getElementById("eps");

if (!bookId) {
  headerEl.innerText = "Drama tidak ditemukan";
  epsEl.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:60px;color:#94a3b8;'>ID drama tidak valid</div>";
} else {
  const title = rawTitle ? decodeURIComponent(rawTitle) : "Daftar Episode";
  headerEl.innerText = title;
  
  // LOAD SEMUA EPISODE SEKALIGUS
  fetch(`https://restxdb.onrender.com/api/chapters/${encodeURIComponent(bookId)}?lang=in`)
    .then(res => res.json())
    .then(res => {
      allEpisodes = res?.data?.chapterList || [];
      
      const freeCount = allEpisodes.filter(c => !c.isCharge).length;
      const vipCount = allEpisodes.length - freeCount;
      
      totalEl.innerHTML = `
        Total: <strong>${allEpisodes.length}</strong> episode 
        (<strong style="color:#10b981;">${freeCount}</strong> gratis, 
         <strong style="color:#f59e0b;">${vipCount}</strong> VIP)
      `;
      
      if (allEpisodes.length === 0) {
        epsEl.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:60px;color:#94a3b8;'>Episode tidak tersedia</div>";
        return;
      }
      
      // LOAD BATCH PERTAMA
      loadEpisodeBatch();
      
      // INFINITE SCROLL
      let loading = false;
      window.addEventListener('scroll', () => {
        if (loading || loadedCount >= allEpisodes.length) return;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const docHeight = document.documentElement.scrollHeight;
        
        if (scrollTop + windowHeight >= docHeight - 1000) {
          loadEpisodeBatch();
        }
      });
    })
    .catch(() => {
      totalEl.innerHTML = "⚠️ Error loading";
      epsEl.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:60px;color:#f87171;'>Gagal memuat episode</div>";
    });
}

function loadEpisodeBatch() {
  const loadingMoreEl = document.createElement('div');
  loadingMoreEl.className = 'loading-more';
  loadingMoreEl.textContent = 'Loading more episodes...';
  epsEl.appendChild(loadingMoreEl);
  
  setTimeout(() => {
    const start = loadedCount;
    const end = Math.min(start + BATCH_SIZE, allEpisodes.length);
    
    for (let i = start; i < end; i++) {
      const chapter = allEpisodes[i];
      const epNum = chapter.chapterIndex + 1;
      const isVip = chapter.isCharge;
      
      const link = document.createElement('a');
      link.href = `watch.html?book=${encodeURIComponent(bookId)}&ep=${chapter.chapterIndex}&title=Episode ${epNum}`;
      link.className = `episode-item ${isVip ? 'vip' : 'free'}`;
      link.innerHTML = `
        <div class="episode-num">${epNum}</div>
        <div class="episode-badge ${isVip ? 'vip-badge' : 'free-badge'}">
          ${isVip ? 'VIP' : 'FREE'}
        </div>
      `;
      epsEl.insertBefore(link, loadingMoreMoreEl);
    }
    
    epsEl.removeChild(loadingMoreEl);
    loadedCount = end;
  }, 500);
}
</script>

</body>
</html>
