<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drama China Terbaru - Streaming HD Gratis</title>
    <meta name="description" content="Nonton Drama China Subtitle Indonesia Terlengkap & Terupdate">
    <meta name="theme-color" content="#38bdf8">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>Drama China</header>

<!-- SEARCH -->
<div class="search-box">
  <input id="search" placeholder="Cari drama..." autocomplete="off">
</div>
<div id="suggest"></div>

<!-- TAB -->
<div class="tabs">
  <button class="active" onclick="loadTab('foryou', this)">Rekomendasi</button>
  <button onclick="loadTab('new', this)">Baru</button>
  <button onclick="loadTab('rank', this)">Populer</button>
</div>

<!-- LIST -->
<div id="list" class="container">
  <div class="loading">Memuat...</div>
</div>

<script>
const listEl = document.getElementById("list");
const suggestEl = document.getElementById("suggest");
const searchInput = document.getElementById("search");

/* Helper sederhana untuk escape HTML */
function escapeHTML(str = "") {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* =====================
   LOAD TAB
===================== */
function loadTab(type, btn) {
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");

  listEl.innerHTML = "<div class='loading'>Memuat...</div>";

  let url = "";
  if (type === "foryou") url = "https://restxdb.onrender.com/api/foryou/1?lang=in";
  if (type === "new")    url = "https://restxdb.onrender.com/api/new/1?lang=in&pageSize=12";
  if (type === "rank")   url = "https://restxdb.onrender.com/api/rank/1?lang=in";

  if (!url) {
    listEl.innerHTML = "<div class='loading'>Tab tidak dikenal</div>";
    return;
  }

  fetch(url)
    .then(res => res.json())
    .then(res => {
      const list = res?.data?.list || [];
      if (!Array.isArray(list) || list.length === 0) {
        listEl.innerHTML = "<div class='loading'>Data kosong</div>";
        return;
      }
      renderList(list);
    })
    .catch(() => {
      listEl.innerHTML = "<div class='loading'>Gagal memuat</div>";
    });
}

/* =====================
   RENDER LIST
===================== */
function renderList(data) {
  listEl.innerHTML = data.map(d => {
    const id = encodeURIComponent(d.bookId);
    const title = escapeHTML(d.bookName);
    const cover = escapeHTML(d.cover);
    const urlTitle = encodeURIComponent(d.bookName || "");
    return `
      <a href="detail.html?id=${id}&title=${urlTitle}">
        <div class="card">
          <img src="${cover}" loading="lazy" alt="${title}">
          <h3>${title}</h3>
        </div>
      </a>
    `;
  }).join("");
}

/* =====================
   SEARCH + SUGGEST
===================== */
let timer;
searchInput.addEventListener("input", () => {
  clearTimeout(timer);
  const q = searchInput.value.trim();
  if (q.length < 2) {
    suggestEl.innerHTML = "";
    return;
  }

  timer = setTimeout(() => {
    fetch(`https://restxdb.onrender.com/api/suggest/${encodeURIComponent(q)}?lang=in`)
      .then(res => res.json())
      .then(res => {
        const list = res?.data?.list || [];
        if (!Array.isArray(list) || list.length === 0) {
          suggestEl.innerHTML = "";
          return;
        }

        suggestEl.innerHTML = list.slice(0, 5).map(s => {
          const text = escapeHTML(s);
          const onClickQ = s.replace(/'/g, "\\'");
          return `<div onclick="doSearch('${onClickQ}')">${text}</div>`;
        }).join("");
      })
      .catch(() => {
        suggestEl.innerHTML = "";
      });
  }, 400);
});

function doSearch(q) {
  searchInput.value = q;
  suggestEl.innerHTML = "";
  listEl.innerHTML = "<div class='loading'>Mencari...</div>";

  fetch(`https://restxdb.onrender.com/api/search/${encodeURIComponent(q)}/1?lang=in`)
    .then(res => res.json())
    .then(res => {
      const list = res?.data?.list || [];
      if (!Array.isArray(list) || list.length === 0) {
        listEl.innerHTML = "<div class='loading'>Tidak ditemukan</div>";
        return;
      }
      renderList(list);
    })
    .catch(() => {
      listEl.innerHTML = "<div class='loading'>Gagal mencari</div>";
    });
}

/* LOAD DEFAULT */
loadTab("foryou", document.querySelector(".tabs button"));
</script>

</body>
</html>
