<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nonton Episode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#0b1220;
      color:#fff;
      font-family:system-ui;
      margin:0;
    }
    header {
      padding:14px;
      background:#020617;
      text-align:center;
      font-weight:600;
      font-size:1.1em;
      position:sticky;
      top:0;
      z-index:10;
    }
    .player-wrap {
      width:100vw;
      height:calc(100vh - 60px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
    }
    video {
      width:100%;
      height:100%;
      max-width:1000px;
      max-height:100%;
      background:#000;
      object-fit:contain;
    }
    .loading, .error {
      text-align:center;
      padding:20px;
      color:#e5e7eb;
    }
    .error a {
      color:#38bdf8;
      text-decoration:none;
    }
    .quality-bar {
      position:absolute;
      bottom:10px;
      right:10px;
      background:rgba(15,23,42,.85);
      border-radius:6px;
      padding:4px 8px;
      display:flex;
      gap:4px;
      font-size:12px;
    }
    .quality-btn {
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      padding:2px 6px;
      border-radius:4px;
    }
    .quality-btn.active {
      background:#38bdf8;
      color:#0f172a;
    }
  </style>
</head>
<body>

<header id="title">Nonton Episode</header>

<div id="playerBox" class="player-wrap">
  <div class="loading">Memuat video...</div>
</div>

<script>
const params   = new URLSearchParams(location.search);
const bookId   = params.get("book");
const epIndex  = params.get("ep");
const rawTitle = params.get("title");

function escapeHTML(str = "") {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

const titleEl  = document.getElementById("title");
const boxEl    = document.getElementById("playerBox");

if (!bookId || epIndex === null) {
  titleEl.innerText = "Error";
  boxEl.innerHTML = `
    <div class="error">
      Parameter episode tidak valid.<br><br>
      <a href="javascript:history.back()">← Kembali</a>
    </div>
  `;
} else {
  const showTitle = rawTitle ? decodeURIComponent(rawTitle) : `Episode ${Number(epIndex)+1}`;
  titleEl.innerText = showTitle;

  const url = `https://restxdb.onrender.com/api/watch/${encodeURIComponent(bookId)}/${encodeURIComponent(epIndex)}?lang=in&source=search_result`;

  fetch(url)
    .then(r => r.json())
    .then(r => {
      const data = r?.data;
      if (!data) throw new Error("Data kosong");

      const qualities = Array.isArray(data.qualities) ? data.qualities : [];
      let defaultQuality = qualities.find(q => q.isDefault === 1);
      if (!defaultQuality && qualities.length) defaultQuality = qualities[0];

      const mainUrl = defaultQuality?.videoPath || data.videoUrl;
      if (!mainUrl) throw new Error("URL video tidak ditemukan");

      renderPlayer(mainUrl, qualities, showTitle);
    })
    .catch(err => {
      boxEl.innerHTML = `
        <div class="error">
          <strong>Gagal memuat video</strong><br><br>
          <small>${escapeHTML(err.message)}</small><br><br>
          <a href="javascript:history.back()">← Kembali</a>
        </div>
      `;
    });
}

function renderPlayer(src, qualities, title) {
  boxEl.innerHTML = "";

  const container = document.createElement("div");
  container.style.position = "relative";
  container.style.width = "100%";
  container.style.height = "100%";
  container.style.display = "flex";
  container.style.justifyContent = "center";
  container.style.alignItems = "center";

  const video = document.createElement("video");
  video.controls = true;
  video.autoplay = true;
  video.playsInline = true;
  video.src = src;
  video.title = title;

  container.appendChild(video);

  // Tombol kualitas
  if (qualities.length) {
    const bar = document.createElement("div");
    bar.className = "quality-bar";

    let currentQuality = src;

    qualities
      .slice() // copy
      .sort((a,b) => b.quality - a.quality)
      .forEach(q => {
        const btn = document.createElement("button");
        btn.className = "quality-btn" + (q.videoPath === currentQuality ? " active" : "");
        btn.textContent = q.quality + "p";

        btn.onclick = () => {
          currentQuality = q.videoPath;
          video.src = q.videoPath;
          video.play();
          document.querySelectorAll(".quality-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        };

        bar.appendChild(btn);
      });

    container.appendChild(bar);
  }

  boxEl.appendChild(container);
}
</script>

</body>
</html>
